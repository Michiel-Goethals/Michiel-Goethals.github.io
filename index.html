<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Omerta Strava Challenge</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{--orange:#ff8c42;--bg:#f4f4f4;--text:#222;--card:#fff;--light-orange:#ffa366;}
    body.dark{--bg:#111;--text:#eee;--card:#1b1b1b}
    body{margin:0;font-family:Arial, 'Roboto', sans-serif;background:var(--bg);color:var(--text);padding:20px;transition:background .2s,color .2s}
    h2,h3{font-family:Roboto, Arial, sans-serif;color:var(--orange);margin:0}

    /* TITLE STYLE */
    h1 {
        font-family: 'Roboto', sans-serif;
        font-size: 32px;
        font-weight: 900;
        letter-spacing: -0.5px;
        color: var(--text); 
        border-bottom: 4px solid var(--orange); 
        padding-bottom: 6px;
        margin-bottom: 14px; 
        display: inline-block;
        transition: color 0.2s;
    }
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .button{background:var(--orange);color:#fff;border:0;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:600}
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);transition:box-shadow .18s}
    .stats-container{display:flex;gap:14px;margin-bottom:14px;flex-wrap:wrap;} 
    .stat-card{flex:1;min-width:180px;padding:14px;border-radius:12px;text-align:center;background:var(--card);box-shadow:0 6px 14px rgba(0,0,0,.06)}

    /* highlight style for points */
    .points-highlight{background:linear-gradient(135deg, rgba(255,140,66,0.12), rgba(255,140,66,0.04));border:1px solid rgba(255,140,66,0.14);box-shadow:0 8px 30px rgba(255,140,66,0.08)}
    
    /* Timer Card Styles (Default state) */
    .countdown-card {
        background: var(--card); 
        color: var(--text); 
        border: 3px solid var(--orange); 
        padding: 14px;
        border-radius: 12px;
        text-align: center;
        flex: 1;
        min-width: 250px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: all 0.2s ease-in-out; /* Smooth transition for non-animated changes */
        box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Subtle default shadow */
    }
    
    /* NEW: Pulsating Animation ONLY on hover */
    .countdown-card:hover {
        animation: pulse-smooth 1s ease-in-out infinite alternate; 
    }

    .countdown-card h3 {
        color: var(--orange); 
        margin-bottom: 4px;
    }
    .countdown-timer {
        font-size: 20px;
        font-weight: 700;
        margin-top: 8px;
    }

    /* Smoother Pulsating Animation */
    @keyframes pulse-smooth {
      0% { 
        transform: scale(1.0); 
        box-shadow: 0 0 0px 0px rgba(255, 140, 66, 0.2); 
      }
      100% { 
        transform: scale(1.01); 
        box-shadow: 0 0 16px 4px rgba(255, 140, 66, 0.8); 
      }
    }
    /* END TIMER STYLE */


    .filters{display:flex;gap:10px;margin:12px 0 18px}
    select{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,.08);background:transparent}

    .map-card{padding:12px}
    #map{height:420px;border-radius:12px;overflow:hidden;position:relative;z-index:1}
    .leaflet-container{z-index:1}
    
    /* Suggestions Card Style */
    .suggestions-list {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
    }
    .suggestion-item {
        background: rgba(255, 140, 66, 0.1);
        color: var(--text);
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 14px;
        border: 1px solid rgba(255, 140, 66, 0.3);
    }


    /* Updated layout for charts inside modal */
    .modal-graphs{display:flex;flex-direction:column;gap:16px;margin-top:14px}
    .modal-graphs .card{padding:12px;margin-bottom:16px;}
    canvas{width:100%;max-height:300px;display:block}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.48);display:none;align-items:center;justify-content:center;z-index:99999}
    .modal-content{background:var(--card);color:var(--text);width:82%;max-height:80vh;overflow:auto;border-radius:12px;padding:18px;box-shadow:0 18px 40px rgba(0,0,0,.25)}
    .close-btn{float:right;background:transparent;border:0;font-size:18px;cursor:pointer}

    @media (max-width:800px){.stats-container{flex-direction:column}}

    /* small icons (SVG) */
    .icon {width:18px;height:18px;vertical-align:middle;margin-right:8px;opacity:0.9}

    <style>
/* ... existing styles ... */

    /* NEW: Progress Bar Styles */
    .progress-container {
        margin-top: 14px;
        background-color: var(--card); /* Match card background */
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid rgba(0,0,0,0.08);
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .progress-labels {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
    }
    .progress-bar-bg {
        width: 100%;
        background-color: var(--bg); /* Light background for the track */
        border-radius: 8px;
        height: 16px;
        overflow: hidden;
    }
    .progress-bar-fill {
        height: 100%;
        background-color: var(--orange); 
        transition: width 0.6s ease-out;
        border-radius: 8px 0 0 8px;
    }
    .progress-bar-text {
        font-size: 16px;
        font-weight: 700;
        margin-top: 10px;
        color: var(--text);
    }
    .progress-bar-text span {
        color: var(--orange);
    }

/* ... existing styles ... */
</style>
  </style>
</head>
<body>
  <div class="header">
    <h1>Omerta Strava Challenge</h1>
    <div>
      <button class="button" id="openActivities">Alle Activiteiten</button>
      <button class="button" id="openGraphs">Grafieken</button> 
      <button class="button" id="regels">Regels</button>
      <button class="button" id="toggleDark" style="margin-left:8px">Toggle Dark</button>
    </div>
  </div>

  <div class="stats-container">
    <div class="stat-card card"><h3>Kilometers Gesport</h3><div id="totalKm" style="font-size:20px;font-weight:700;margin-top:8px">0 km</div></div>
    <div class="stat-card card"><h3>Totale Tijd Gesport</h3><div id="totalTime" style="font-size:20px;font-weight:700;margin-top:8px">0h 0m 0s</div></div>
    <div class="stat-card card"><h3>Aantal Activiteiten</h3><div id="totalActivities" style="font-size:20px;font-weight:700;margin-top:8px">0</div></div>
    <div class="stat-card card points-highlight"><h3 style="display:flex;align-items:center;justify-content:center"><svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L15 9H22L17 14L19 21L12 17L5 21L7 14L2 9H9L12 2Z" fill="currentColor"/></svg> Punten</h3><div id="totalPoints" style="font-size:26px;font-weight:800;margin-top:8px;color:var(--orange)">0</div></div>
    
    <div class="countdown-card">
      <h3>Einde Challenge</h3>
      <div id="countdownTimer" class="countdown-timer">0d 0h 0m 0s</div>
    </div>
  </div>

  <div class="card map-card">
    <h2>Naar waar kunnen we gaan</h2>
    <div id="map"></div>
  </div>

  <div id="suggestionsCard" class="card" style="margin-top:14px;">
    <h2>Suggesties Binnen Bereik</h2>
        <div id="progressBarContainer" class="progress-container">
        </div>
  </div>
    <div id="suggestionsList" class="suggestions-list">
    </div>

    <div id="suggestionsList" class="suggestions-list">
        </div>
  </div>
  <div  class="filters card" style="margin-top:12px" hidden>
    <label hidden for="filterType">Type</label>
    <select  hidden id="filterType"><option value="all">Alle types</option></select>
    <label hidden for="filterUser">Deelnemer</label>
    <select hidden id="filterUser"><option value="all">Alle deelnemers</option></select>
  </div>

  <div class="modal" id="modal"><div class="modal-content" id="modalContent"><button class="close-btn" id="closeModal">✕</button><h2>Alle Activiteiten</h2><div id="modalList"></div></div></div>
  <div class="modal" id="regelModal"><div class="modal-content" id="regelModalContent"><button class="close-btn" id="closeRegelModal">✕</button><h2>Regels</h2><div id="regelModalList"></div></div></div>
  
  <div class="modal" id="graphModal">
    <div class="modal-content" id="graphModalContent">
      <button class="close-btn" id="closeGraphModal">✕</button>
      <h2>Overzicht Grafieken</h2>
      <div class="modal-graphs">
        <div class="card"><h3>Punten per Type</h3><canvas id="activityChart"></canvas></div>
        <div class="card"><h3>Kilometer per Type</h3><canvas id="kmChart"></canvas></div>
        <div class="card"><h3>Tijd per Type (uren)</h3><canvas id="timeChart"></canvas></div> 
      </div>
    </div>
  </div>


  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script>
    // --- DATA ---
const ALL_ACTIVITIES = [
  {
    "Datum": "1 Dec",
    "Deelnemer": "Michiel",
    "Activiteitstype": "Fietsen",
    "Tijd": "00:32:01",
    "Kilometer": 10.33,
    "Punten": 1
  },
  {
    "Datum": "2 Dec",
    "Deelnemer": "Michiel",
    "Activiteitstype": "Fietsen",
    "Tijd": "01:16:24",
    "Kilometer": 40.58,
    "Punten": 1
  },
  {
    "Datum": "3 Dec",
    "Deelnemer": "Elke",
    "Activiteitstype": "Lopen",
    "Tijd": "01:11:57",
    "Kilometer": 11.11,
    "Punten": 1
  },
  {
    "Datum": "3 Dec",
    "Deelnemer": "Michiel",
    "Activiteitstype": "Kracht",
    "Tijd": "00:37:24",
    "Kilometer": 0,
    "Punten": 1
  },
  {
    "Datum": "4 Dec",
    "Deelnemer": "Michiel",
    "Activiteitstype": "Fietsen",
    "Tijd": "01:08:59",
    "Kilometer": 44.59,
    "Punten": 1
  },
  {
    "Datum": "6 Dec",
    "Deelnemer": "Elke",
    "Activiteitstype": "Lopen",
    "Tijd": "02:15:00",
    "Kilometer": 20.12,
    "Punten": 2
  }
];

const SUGGESTED_CITIES = [
    { name: "Gele Koten (1)", distance: 1 },
    { name: "Rue D'Aarschot (5)", distance: 5 },
    { name: "Tervuren (11)", distance: 11 },
    { name: "Aalst (24)", distance: 24 },
    { name: "Gent (50)", distance: 50 },
    { name: "Sint-Truiden (57)", distance: 57 },
    { name: "Hasselt (69)", distance: 69 },
    { name: "Dinant (78)", distance: 78 },
    { name: "Hoge Kempen (93)", distance: 93 },
    { name: "Brugge (97)", distance: 97 },
    { name: "Oostende (108)", distance: 108 },
    { name: "Rotterdam (118)", distance: 118 },
    { name: "Bouillon (124)", distance: 124 },
    { name: "Butchenbach (139)", distance: 139 },
    { name: "Aarlen (167)", distance: 167 },
    { name: "Mullerthal (182)", distance: 182 },
    { name: "Wissant (192)", distance: 192 },
    { name: "Keulen (198)", distance: 198 },
    { name: "Amsterdam (208)", distance: 208 },
    { name: "Texel (245)", distance: 245 },
    { name: "Rouen (288)", distance: 288 },
    { name: "Londen (320)", distance: 320 },
    { name: "Straatsburg (345)", distance: 345 },
    { name: "Dijon (395)", distance: 395 },
    { name: "Basel (425)", distance: 425 },
    { name: "Bath (480)", distance: 480 },
    { name: "Interlaken (530)", distance: 530 },
    { name: "Chamonix (580)", distance: 580 },
    { name: "Munchen (602)", distance: 602 },
    { name: "Innsbruck (640)", distance: 640 },
    { name: "Bolzano (705)", distance: 705 },
    { name: "Praag (715)", distance: 715 },
    { name: "Edinburgh (754)", distance: 754 },
    { name: "Kopenhagen (763)", distance: 763 },
    { name: "Dublin (780)", distance: 780 },
    { name: "Nice (818)", distance: 818 },
    { name: "Ljubljana (915)", distance: 915 },
    { name: "Andorra (945)", distance: 945 },
    { name: "Sienna (980)", distance: 980 },
    { name: "Corsica (1040)", distance: 1040 },
    { name: "Bergen (1060)", distance: 1060 },
    { name: "Warschau (1150)", distance: 1150 },
    { name: "Split (1220)", distance: 1220 },
    { name: "Mallorca (1260)", distance: 1260 },
    { name: "Sarajevo (1310)", distance: 1310 },
    { name: "Amalfi (1385)", distance: 1385 },
    { name: "Palermo (1580)", distance: 1580 },
    { name: "Tallin (1600)", distance: 1600 },
    { name: "Lissabon (1715)", distance: 1715 },
    { name: "Abisko (2095)", distance: 2095 },
    { name: "Marrakesh (2370)", distance: 2370 },
    { name: "Gran Canaria (3050)", distance: 3050 },
    { name: "Thailand (9250)", distance: 9250 }
];

    // expose globally (used by circle logic)
    window.ALL_ACTIVITIES = ALL_ACTIVITIES;

    // --- HELPERS ---
    function parseTimeToSeconds(t){
      if(!t) return 0;
      const p = String(t).split(':').map(Number);
      return (p[0]||0)*3600 + (p[1]||0)*60 + (p[2]||0);
    }
    function formatHMS(sec){const h=Math.floor(sec/3600);sec%=3600;const m=Math.floor(sec/60);const s=sec%60;return `${h}h ${m}m ${s}s`}

    // Countdown Logic
    const END_DATE = new Date('2026-03-31T23:59:59').getTime();
    function updateCountdown() {
      const now = new Date().getTime();
      const distance = END_DATE - now;
      const countdownEl = document.getElementById('countdownTimer');

      if (distance < 0) {
        countdownEl.innerHTML = "Challenge is afgelopen!";
        return;
      }

      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);

      countdownEl.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
    }

    // --- UI elements ---
    const filterType = document.getElementById('filterType');
    const filterUser = document.getElementById('filterUser');
    const modal = document.getElementById('modal');
    const modalList = document.getElementById('modalList');
    const regelModal = document.getElementById('regelModal');
    const regelModalList = document.getElementById('regelModalList');
    const graphModal = document.getElementById('graphModal'); 
    const suggestionsList = document.getElementById('suggestionsList'); // NEW

    // populate filters dynamically
    const types = Array.from(new Set(ALL_ACTIVITIES.map(d=>d.Activiteitstype)));
    const users = Array.from(new Set(ALL_ACTIVITIES.map(d=>d.Deelnemer)));
    types.forEach(t=>{const o=document.createElement('option');o.value=t;o.innerText=t;filterType.appendChild(o)});
    users.forEach(u=>{const o=document.createElement('option');o.value=u;o.innerText=u;filterUser.appendChild(o)});

    // charts
    let activityChart=null, kmChart=null, timeChart=null; 
    function buildCharts(dataset){
      const pointsByType = {};
      const kmByType = {};
      const timeByTypeSec = {}; 

      dataset.forEach(d=>{
        pointsByType[d.Activiteitstype]=(pointsByType[d.Activiteitstype]||0)+d.Punten;
        kmByType[d.Activiteitstype]=(kmByType[d.Activiteitstype]||0)+d.Kilometer;
        timeByTypeSec[d.Activiteitstype]=(timeByTypeSec[d.Activiteitstype]||0)+parseTimeToSeconds(d.Tijd); 
      });

      // Convert time from seconds to hours for display
      const timeByTypeHours = Object.keys(timeByTypeSec).reduce((acc, key) => {
          acc[key] = timeByTypeSec[key] / 3600; 
          return acc;
      }, {});

      const activityCtx = document.getElementById('activityChart').getContext('2d');
      const kmCtx = document.getElementById('kmChart').getContext('2d');
      const timeCtx = document.getElementById('timeChart').getContext('2d'); 

      if(activityChart) activityChart.destroy();
      if(kmChart) kmChart.destroy();
      if(timeChart) timeChart.destroy(); 

      activityChart = new Chart(activityCtx, {type:'bar',data:{labels:Object.keys(pointsByType),datasets:[{label:'Punten',data:Object.values(pointsByType),backgroundColor:'rgba(255,140,66,0.95)',borderRadius:6}]},options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{beginAtZero:true}}}});

      kmChart = new Chart(kmCtx, {type:'bar',data:{labels:Object.keys(kmByType),datasets:[{label:'Kilometer',data:Object.values(kmByType),backgroundColor:'rgba(255,166,77,0.95)',borderRadius:6}]},options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{beginAtZero:true, title: {display: true, text: 'Kilometer'}}}}});

      // Time Chart configuration (using main orange color)
      timeChart = new Chart(timeCtx, {type:'bar',data:{labels:Object.keys(timeByTypeHours),datasets:[{label:'Tijd (uur)',data:Object.values(timeByTypeHours),backgroundColor:'rgba(255,140,66,0.95)',borderRadius:6}]},options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{beginAtZero:true, title: {display: true, text: 'Uren'}}}}});
    }

    // stats (based on filtered dataset)
    function updateStats(dataset){
      const totalP = dataset.reduce((s,x)=>s + (x.Punten||0), 0);
      const totalKm = dataset.reduce((s,x)=>s + Math.round(x.Kilometer||0), 0);
      const totalSec = dataset.reduce((s,x)=>s + parseTimeToSeconds(x.Tijd||0), 0);
      document.getElementById('totalPoints').innerText = totalP;
      document.getElementById('totalKm').innerText = totalKm + ' km';
      document.getElementById('totalTime').innerText = formatHMS(totalSec);
      document.getElementById('totalActivities').innerText = dataset.length;
      
      // Update suggestions when stats change
      updateSuggestions(totalP);
    }

    // --- MAP SETUP ---
    const brussels = [50.8222,4.3969];
    const map = L.map('map',{zoomControl:true}).setView(brussels,10);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'© OpenStreetMap, © CartoDB'}).addTo(map);

    // circle that ALWAYS uses the FULL dataset (ALL_ACTIVITIES)
    let circleLayer = null;
    function drawCircleForDataset(){
      const full = window.ALL_ACTIVITIES || [];
      const totalP = full.reduce((s,x)=>s + (x.Punten||0), 0);
      const meters = Math.max(50, totalP * 1000);
      if(circleLayer) circleLayer.remove();
      try{map.invalidateSize()}catch(e){}
      circleLayer = L.circle(brussels,{radius:meters,color:'rgba(255,120,40,1)',fillColor:'rgba(255,120,40,0.18)',fillOpacity:0.55,weight:5}).addTo(map);
      setTimeout(()=>{try{map.invalidateSize()}catch(e){};map.fitBounds(circleLayer.getBounds(),{padding:[40,40]})},120);
    }

    // --- SUGGESTIONS LOGIC ---
    function updateSuggestions(totalPoints) {
        const radiusKm = totalPoints; // As per rules: Aantal punten = aantal kilometers.
        
        let html = '';
        const relevantCities = SUGGESTED_CITIES.filter(city => city.distance <= radiusKm).sort((a, b) => a.distance - b.distance);
        const furtherCities = SUGGESTED_CITIES.filter(city => city.distance > radiusKm).sort((a, b) => a.distance - b.distance);

        if (relevantCities.length > 0) {
            html += relevantCities.map(city => `<span class="suggestion-item" style="background: rgba(255, 140, 66, 0.2); font-weight: 700;">${city.name}</span>`).join('');
        }
        
        // Show cities that are further away as grayed out goals
        if (furtherCities.length > 0) {
             html += furtherCities.map(city => `<span class="suggestion-item" style="background: rgba(0,0,0,0.05); opacity: 0.6; color: var(--text);">${city.name}</span>`).join('');
        }

        if (html === '') {
             suggestionsList.innerHTML = '<span class="suggestion-item">Helaas, de afstand is nog te klein om een stad te bereiken. Blijf sporten!</span>';
        } else {
             suggestionsList.innerHTML = html;
        }
    }

    // ... existing script content ...

    // --- SUGGESTIONS LOGIC ---
    const progressBarContainer = document.getElementById('progressBarContainer'); // NEW

    function updateSuggestions(totalPoints) {
        const radiusKm = totalPoints; // As per rules: Aantal punten = aantal kilometers.
        
        let html = '';
        // The cities that are currently reachable (distance <= radiusKm)
        const relevantCities = SUGGESTED_CITIES.filter(city => city.distance <= radiusKm).sort((a, b) => a.distance - b.distance);
        // The cities that are currently NOT reachable (distance > radiusKm)
        const furtherCities = SUGGESTED_CITIES.filter(city => city.distance > radiusKm).sort((a, b) => a.distance - b.distance);

        if (relevantCities.length > 0) {
            html += relevantCities.map(city => `<span class="suggestion-item" style="background: rgba(255, 140, 66, 0.2); font-weight: 700;">${city.name}</span>`).join('');
        }
        
        // Show cities that are further away as grayed out goals
        if (furtherCities.length > 0) {
             html += furtherCities.map(city => `<span class="suggestion-item" style="background: rgba(0,0,0,0.05); opacity: 0.6; color: var(--text);">${city.name}</span>`).join('');
        }

        if (html === '') {
             suggestionsList.innerHTML = '<span class="suggestion-item">Helaas, de afstand is nog te klein om een stad te bereiken. Blijf sporten!</span>';
        } else {
             suggestionsList.innerHTML = html;
        }

        // --- NEW: Progress Bar Logic ---
        if (furtherCities.length > 0) {
            const nextCity = furtherCities[0];
            const nextDistance = nextCity.distance;
            
            // The distance that needs to be covered to reach the next city
            const totalToCover = nextDistance - (relevantCities.length > 0 ? relevantCities[relevantCities.length - 1].distance : 0);
            
            // The distance covered since the last city (or from 0)
            const coveredSinceLast = totalPoints - (relevantCities.length > 0 ? relevantCities[relevantCities.length - 1].distance : 0);

            // Special case for the very first city (from 0 km to first city distance)
            const progressFraction = (relevantCities.length === 0) 
                ? (totalPoints / nextDistance) 
                : (coveredSinceLast / totalToCover);

            const progressPercentage = Math.min(100, Math.floor(progressFraction * 100));

            const remainingDistance = nextDistance - totalPoints;
            const remainingText = Math.max(0, remainingDistance).toFixed(0); 

            progressBarContainer.innerHTML = `
                <div class="progress-labels">
                    <span style="color: var(--orange);">${totalPoints} punten</span>
                    <span>${nextCity.name}</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width: ${progressPercentage}%;"></div>
                </div>
                <div class="progress-bar-text">
                    Nog <span>${remainingText} punten</span> tot het volgende doel!
                </div>
            `;
        } else {
            // All cities reached
            progressBarContainer.innerHTML = `
                <div class="progress-bar-text" style="color: green; text-align: center;">
                    Gefeliciteerd! Alle voorgestelde bestemmingen zijn binnen bereik!
                </div>
            `;
        }
        // --- END: Progress Bar Logic ---
    }


    // --- FILTERING ---
    function getFiltered(){
      const type = filterType.value;
      const user = filterUser.value;
      return ALL_ACTIVITIES.filter(d=> (type==='all'||d.Activiteitstype===type) && (user==='all'||d.Deelnemer===user));
    }
    function updateFilters(){
      const filtered = getFiltered();
      updateStats(filtered);
      buildCharts(filtered);
      renderModalList(filtered);
      // IMPORTANT: do NOT update circle here; circle must reflect ALL_ACTIVITIES
    }

    // --- MODAL ACTIVITIES ---
    function openModal(){modal.style.display='flex';renderModalList(ALL_ACTIVITIES)}
    function closeModal(){modal.style.display='none'}
    function renderModalList(list){
      const el = modalList; if(!list) list = ALL_ACTIVITIES;
      if(list.length===0) el.innerHTML = '<p>Geen activiteiten gevonden</p>';
      else el.innerHTML = list.map(d=>`<div style="padding:8px;border-bottom:1px solid rgba(0,0,0,.06)"><strong>${d.Deelnemer}</strong> — ${d.Activiteitstype} — ${d.Datum} — ${d.Kilometer} km — ${d.Tijd} — ${d.Punten} pt</div>`).join('');
    }

    // --- MODAL GRAPHS ---
    function openGraphModal(){graphModal.style.display='flex'; buildCharts(ALL_ACTIVITIES); } 
    function closeGraphModal(){graphModal.style.display='none'}

    // --- MODAL RULES ---
    function openRegelModal(){regelModal.style.display='flex';renderRegelModalList()}
    function closeRegelModal(){regelModal.style.display='none'}
    function renderRegelModalList(){
       const el = regelModalList;
       el.innerHTML = "Periode: 1 december tot 31 maart<br>Voorwaarden:<br>Woonwerkverkeer telt niet mee voor deze challenge<br>Maximum 1 activiteit per dag telt voor deze challenge<br><br>Elke activiteit voor deze challenge duurt minstens 30 minuten.<br>Volledige transparantie/geen verborgen activiteiten<br><br><br>Puntentelling:<br>1 punt = activiteit van minstens 30 minuten tot 1u59 activiteit registratie<br>2 punten = 2u – 2u59 activiteit registratie<br>3 punten = 3u – 3u59 activiteit registratie<br>4 punten = 4u tot 4u59 activiteit registratie<br>5 punten = 5u tot 5u59 activiteit registratie<br>Enz…<br><br>Resultaat<br>Na de challenge periode tellen we het aantal punten van alle deelnemers op.<br>Aantal punten = aantal kilometers.<br>Aantal kilometers = trekken een cirkel radius en kiezen een bestemming op basis van deze afstand om met alle deelnemers naartoe te gaan.";
    }

    // --- EVENTS ---
    document.getElementById('openActivities').addEventListener('click', openModal);
    document.getElementById('closeModal').addEventListener('click', closeModal);    
    document.getElementById('regels').addEventListener('click', openRegelModal);
    document.getElementById('closeRegelModal').addEventListener('click', closeRegelModal); 
    document.getElementById('openGraphs').addEventListener('click', openGraphModal); 
    document.getElementById('closeGraphModal').addEventListener('click', closeGraphModal); 
    document.getElementById('toggleDark').addEventListener('click', ()=>document.body.classList.toggle('dark'));
    
    // Close modals with Escape key
    window.addEventListener('keydown', e=>{ 
        if(e.key==='Escape') {
            closeModal();
            closeRegelModal();
            closeGraphModal(); 
        }
    });

    // --- INITIALIZE ---
    updateStats(ALL_ACTIVITIES);
    drawCircleForDataset();
    renderModalList(ALL_ACTIVITIES);
    updateCountdown();
    setInterval(updateCountdown, 1000);

    // ensure map draws correctly after layout
    setTimeout(()=>{try{map.invalidateSize();}catch(e){}} , 200);
  </script>
</body>
</html>
